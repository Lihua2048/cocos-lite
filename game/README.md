# Cocos Engine 游戏构建系统

## 概述

本构建系统为 Cocos Engine ademo 项目提供将场景数据打包成 H5 游戏和微信小游戏的完整解决方案。

## 目录结构

```
ademo/
├── build/                          # 构建系统
│   ├── GameBuilder.ts              # 核心构建器
│   ├── BuildManagerPanel.tsx       # 构建管理面板
│   ├── runtime/                    # 游戏运行时
│   │   ├── RuntimeSceneManager.ts  # 运行时场景管理
│   │   └── GameLoop.ts             # 游戏主循环
│   ├── build.js                    # 命令行构建脚本
│   ├── preview.js                  # 预览服务器
│   ├── package.json                # 构建工具依赖
│   └── tsconfig.build.json         # 构建 TS 配置
└── game/                           # 构建输出目录
    ├── h5/                         # H5 游戏包
    │   ├── index.html              # 游戏入口
    │   ├── game.js                 # 游戏运行时
    │   ├── data/scenes.json        # 场景数据
    │   ├── assets/                 # 资源文件
    │   └── runtime/                # 运行时库
    └── wechat/                     # 微信小游戏包
        ├── game.json               # 小游戏配置
        ├── game.js                 # 游戏运行时
        ├── adapter.js              # 微信适配器
        ├── data/scenes.json        # 场景数据
        ├── assets/                 # 资源文件
        └── runtime/                # 运行时库
```

## 功能特性

### 1. 多平台支持
- **H5 游戏**: 标准 Web 游戏，支持现代浏览器
- **微信小游戏**: 原生微信小游戏，包含适配器和配置

### 2. 场景数据转换
- 将编辑器场景数据转换为运行时格式
- 保持实体、组件、动画、物理等完整信息
- 支持多场景切换和管理

### 3. 资源打包
- 自动复制纹理、字体、音频资源
- SDF 字体文件打包
- 资源路径自动处理

### 4. 运行时系统
- 轻量级游戏运行时
- WebGL 渲染器集成
- 物理世界同步
- 动画系统支持

### 5. 开发工具
- 可视化构建面板
- 命令行构建脚本
- 本地预览服务器
- 热重载支持

## 使用指南

### 1. 安装构建工具

```bash
cd ademo
npm run build:install
```

### 2. 在编辑器中构建

在编辑器界面使用"构建管理面板"：
- 点击"构建 H5 游戏"或"构建微信小游戏"
- 构建完成后文件生成到 `game/` 目录

### 3. 命令行构建

```bash
# 构建 H5 游戏
npm run build:h5

# 构建微信小游戏
npm run build:wechat
```

### 4. 预览游戏

```bash
# 预览 H5 游戏
npm run preview:h5

# 浏览器访问 http://localhost:3000
```

### 5. 部署发布

#### H5 游戏部署
1. 将 `game/h5/` 目录上传到 Web 服务器
2. 访问 `index.html` 即可运行游戏

#### 微信小游戏发布
1. 使用微信开发者工具打开 `game/wechat/` 目录
2. 上传代码到微信后台
3. 提交审核发布

## 核心架构

### GameBuilder
负责核心构建逻辑：
- 生成运行时代码
- 转换场景数据
- 处理资源文件
- 生成平台配置

### RuntimeSceneManager
运行时场景管理器：
- 场景加载和切换
- 实体数据管理
- 动画状态维护

### GameLoop
游戏主循环：
- 物理世界更新
- 动画插值计算
- 渲染同步
- 性能监控

## 扩展开发

### 添加新平台支持
1. 在 `GameBuilder` 中添加新的构建方法
2. 实现平台特定的适配器
3. 添加构建配置模板

### 自定义资源处理
1. 扩展 `copyResources` 方法
2. 添加新的资源类型支持
3. 实现资源压缩优化

### 优化运行时性能
1. 对象池管理
2. 渲染批处理
3. 资源预加载

## 技术栈

- **构建工具**: Node.js, TypeScript, Webpack
- **运行时**: WebGL, Canvas 2D, Planck.js (物理)
- **平台适配**: 微信小游戏 API
- **开发工具**: Express (预览服务器), Chokidar (热重载)

## 注意事项

1. **资源路径**: 确保所有资源使用相对路径
2. **平台限制**: 微信小游戏有包体大小限制 (4MB)
3. **性能优化**: 生产环境启用代码压缩和资源优化
4. **兼容性**: H5 游戏需考虑移动端浏览器兼容性

## 故障排除

### 构建失败
- 检查 TypeScript 编译错误
- 确认资源文件路径正确
- 查看构建日志输出

### 游戏运行异常
- 检查浏览器控制台错误
- 确认 WebGL 支持
- 验证场景数据格式

### 微信小游戏问题
- 检查 game.json 配置
- 确认适配器正常加载
- 使用微信开发者工具调试
